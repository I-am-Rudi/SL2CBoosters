/*  
 *  Copyright 2020 Francesco Gozzini < gozzini AT cpt.univ-mrs.fr >
 *
 *  This file is part of SL2CFOAM-NEXT.
 *
 *  SL2CFOAM-NEXT is free software: you can redistribute it and/or modify 
 *  it under the terms of the GNU Lesser General Public License as
 *  published by the Free Software Foundation, either version 3 of the
 *  License, or (at your option) any later version.
 *
 *  SL2CFOAM-NEXT is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 *  See the GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License
 *  along with SL2CFOAM-NEXT. If not, see <http://www.gnu.org/licenses/>.
 */

#include <mpfr.h>
#include <mpc.h>

#include "common.h"
#include "cgamma.h"
#include "error.h"


int sl2cfoam_complex_lngamma(mpc_t rop, mpc_t op, cgamma_lanczos* lanczos) {

        bool s = false;

        mpfr_t rez, imz, t;
        mpfr_init2(rez, MPBITS);
        mpfr_init2(imz, MPBITS);
        mpfr_init2(t, MPBITS);

        mpc_real(rez, op, MPC_RNDNN);
        mpc_imag(imz, op, MPC_RNDNN);

        if (mpfr_cmp_ui(rez, 0) < 0) { // if rez < 0

            mpfr_ui_sub(rez, 1, rez, MPFR_RNDN);
            mpfr_neg(imz, imz, MPFR_RNDN);
            s = true;

        }

        mpc_t z, res, Lg, x, y, w;
        mpc_init2(z, MPBITS);
        mpc_init2(res, MPBITS);
        mpc_init2(Lg, MPBITS);
        mpc_init2(x, MPBITS);
        mpc_init2(y, MPBITS);
        mpc_init2(w, MPBITS);

        mpfr_sub_ui(rez, rez, 1, MPFR_RNDN);
        mpc_set_fr_fr(z, rez, imz, MPC_RNDNN);
        mpc_set_fr(Lg, lanczos->c[0], MPC_RNDNN);

        for (int i = 1; i < lanczos->n; i++) {

            mpc_set_fr(x, lanczos->c[i], MPC_RNDNN);
            mpc_add_si(y, z, i, MPC_RNDNN);
            mpc_div(x, x, y, MPC_RNDNN);
            mpc_add(Lg, Lg, x, MPC_RNDNN);

        }

        mpc_set_ui(res, 0, MPC_RNDNN);

        mpc_log(w, Lg, MPC_RNDNN);
        mpc_add(res, res, w, MPC_RNDNN);

        mpfr_set_d(t, 0.5, MPFR_RNDN);
        mpc_add_fr(x, z, t, MPC_RNDNN);

        mpfr_set_d(t, lanczos->g, MPFR_RNDN);
        mpc_add_fr(y, x, t, MPC_RNDNN); // y = z + g + 0.5

        mpc_log(w, y, MPC_RNDNN);
        mpc_mul(w, x, w, MPC_RNDNN);

        mpc_add(res, res, w, MPC_RNDNN);
        mpc_sub(res, res, y, MPC_RNDNN);

        if (s) {

            mpc_neg(res, res, MPC_RNDNN);

            mpfr_const_pi(t, MPFR_RNDN);
            mpfr_log(t, t, MPFR_RNDN);
            mpc_add_fr(res, res, t, MPC_RNDNN);

            mpfr_const_pi(t, MPFR_RNDN);
            mpc_mul_fr(y, z, t, MPC_RNDNN);
            mpc_sin(y, y, MPC_RNDNN);
            mpc_neg(y, y, MPC_RNDNN);
            mpc_log(y, y, MPC_RNDNN);
            mpc_sub(res, res, y, MPC_RNDNN);

        }

        int rcod;
        rcod = mpc_set(rop, res, MPC_RNDNN);

        // clear variables
        mpfr_clear(rez);
        mpfr_clear(imz);
        mpfr_clear(t);

        mpc_clear(z);
        mpc_clear(res);
        mpc_clear(Lg);
        mpc_clear(x);
        mpc_clear(y);
        mpc_clear(w);

        return rcod;

}

int sl2cfoam_complex_gamma(mpc_t rop, mpc_t op, cgamma_lanczos* lanczos) {

    sl2cfoam_complex_lngamma(rop, op, lanczos);
    return mpc_exp(rop, rop, MPC_RNDNN);

}

// the Lanczos coefficients are generated
// using the program taken at http://www.vttoth.com/CMS/projects/41
void sl2cfoam_cgamma_lanczos_fill(cgamma_lanczos* lanczos) {

    // set N and G for Lanczos expansion

    if (MPBITS == 128) {

        lanczos->n = 17;
        lanczos->g = 12.2252227365970611572265625;

    } else if (MPBITS == 256) {

        lanczos->n = 24;
        lanczos->g = 20.3209821879863739013671875;

    } else {

        lanczos->n = 42;
        lanczos->g = 43.1;

    }

    // store the coefficients

    lanczos->c = (mpfr_ptr*) malloc(lanczos->n * sizeof(mpfr_ptr));

    for (int i = 0; i < lanczos->n; i++) {
        lanczos->c[i] = (mpfr_ptr) malloc(sizeof(mpfr_t));
        mpfr_init2(lanczos->c[i], MPBITS);
    }

    switch (lanczos->n)
    {

    case 17:
        mpfr_set_str(lanczos->c[0], "2.50662827463100050241576877021111444209", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[1], "423408.9991884676669161841668330341301399", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[2], "-1597770.991303564809843311018899095193797", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[3], "2467910.842397107889541030115624066203098", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[4], "-2013180.271900769125145885777627095042365", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[5], "934135.5698216499317600878271131965412205", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[6], "-247703.7475470614612367312009283784458683", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[7], "35871.59299395352621627327049831655257139", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[8], "-2557.848167527055392027900582575692445435", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[9], "73.64058624055242262220458351653056336235", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[10], "-.5755793413918741773974294671285772498212", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[11], ".0004746418775183709861234965625092589782438", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[12], "-.000000001397559508318726315896330153361683263197", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[13], ".0000000001268824948834056182616714868379929862014", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[14], "-.00000000006223405738512877283178165800546556068294", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[15], ".00000000001387079369722509277914769320347503058091", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[16], "-.000000000001329400365165616344289473087518461201356", 10, MPFR_RNDN);
        break;

    case 24:
        mpfr_set_str(lanczos->c[0], "2.5066282746310005024157652848110451596655598674530375605432", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[1], "1805950222.9575042779795902863890556359017720811074398819443", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[2], "-12184624049.068613798556209004572912467398675916385343836418", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[3], "36800466242.096664287221397818251409535538102286871960871144", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[4], "-65703457254.507007908028966619437582150596906703737367186271", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[5], "77144418181.330442366625272268857477987191002499438218139399", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[6], "-62706556726.681061627339825990632043439772233177666327834011", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[7], "36186509987.396519198048765625930256761600120647907288334191", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[8], "-14964458513.391092388513833889614355316395926116294002143574", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[9], "4424071084.0802866461400454095414927696841367585171372041604", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[10], "-923130926.18050085585864882818047860831526555361606985154163", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[11], "132758407.34477435960049915364232455495089937889667379129555", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[12], "-12682154.510569015841903861229100747572026861908546595045244", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[13], "762146.8398256305822789392620261312239214977519219321999704", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[14], "-26605.288177626587039475857975491103999400541414267701236104", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[15], "478.69403045398172372399866298060881356950381837893778895599", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[16], "-3.6798237451273319582506214724092707108115180178716541481381", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[17], ".0088043967184116786082382030336794087567784790969083188404675", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[18], "-.0000035981105467111289019890832601851257222451283594041361490238", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[19], ".000000000063118835323956288022116827400751462196855670413096636042821", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[20], "-.00000000000000018850466749285573798078389805284737492428178205465563732277", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[21], ".000000000000000073332569491966572288908749653757232576103963322948425019123", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[22], "-.000000000000000014871647396254379839055237905989240285604623098778295381333", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[23], ".0000000000000000012073837381273806641935367003991376441880001262863068247233", 10, MPFR_RNDN);
        break;

    case 42:
        mpfr_set_str(lanczos->c[0], "2.50662827463100050241576528481104525300698674060993831662992403716826276762115199795150285232035436293022719067253847559454569497025187330515787063680967363", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[1], "20684723915661364238.7827297217057312557567937914753364044476529357212596608762637024407759956790172679161705463893354348881972906450763646607700375314037932", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[2], "-312817069441487817999.947554844510446322305911356752195860466402614585071183858928529075967774968129065951334548364800036639675497251079128631690146729706625", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[3], "2252376842487364035484.05387508656853990454016961496343590140531760755253966450429238842175243216677098787317203395714214445676650125396028590658322280303214", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[4], "-10276456393610250704845.9026832405331121027065829975334973922671943672713470307442404219317189095244450780126193767189884169920055468081507556142124470270728", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[5], "33357894496840392607926.2694143334584059558294415527424294574174515466770496697450756866294345760941484803946442220000339261657809719256785826981042342354248", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[6], "-82001995433263355058855.9991952342363762996483590654333301305938318431073770823061275488550625917261055382022086216681383132667997246172066200869564788326213", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[7], "158661880114475634954158.264385046738700581607457714321428173317695501337221613300880069169986770779500197117862810221187468766619972282079362455881409134293", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[8], "-247929385564855287836669.086654260781676453720413923106145260128196872773701878105250966824796869109954416600621872241048042181935919268582784042746210144567", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[9], "318577712939773570279332.40146806183088169166299001135464773019953239761785557367320127081124423604194210470031110101658073016382878919725440503758845073581", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[10], "-341000247554858097082172.890994522198687948195433360458903984586063291682800679823587213092116475828309838559657742388179612112924781378166992014946254008982", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[11], "306917659637425893931140.250637830910996962352259693414585650711562934351970133261026161851195885084579973131914641053120136073883917209671289858351929894318", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[12], "-233857531002629338103085.878338340506978078628478730880893592778993139624177808943362052456569768060170284496231875685256062959355251562766558867290632854696", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[13], "151562588256467333326071.1915944246928860326100586106788650287348016359963123576439415627592579411934871120920751708612463829650860093972708303629681237215", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[14], "-83805871608176979513571.4354045905423860694514595184472274152430597461768480533422517765410783734878043296870004442202572062095783537035090192692744349598831", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[15], "39602382193814251011718.5515973071822140561202828935611975589255484828565441257506289132229096071492024352213513850903676270528129168043748823317367228103206", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[16], "-15999958692093114752822.4907098088319402371764319692257166482989359201635473507289871514459523610184125612619240886713798333225275896862303459754401942846989", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[17], "5522816698104954820661.27080823619025582638667336830173151158846328355588904825187751626536780780841449077128304815134924913142324761943110671686134883907471", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[18], "-1625809341311699477448.24629111735000294652466064113822967135602419562795009628449231884254621865257612714050058438573142911971551630840299003643131959996796", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[19], "407007784759541399604.361071763667328210742920878565217900040220849879186150037737943470866732610758690721333105142909098320901081392031303861327843473117594", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[20], "-86305646399644818958.7003603229877371416344001543237246602597044631087815559034758222320338092998652217385446153890966988387712172221564756686646016752862398", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[21], "15422460857065507857.7356359914724357969974892803322915842394786398647498280246543073449338100390766114866955073441794399481956151132291172811089907872928449", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[22], "-2307663852330559330.955348135302085690967721803094605236788552534035647909822945760283856447113026206227172554856179165181521837235283809134658849465440472", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[23], "286887874618904916.962669423549642130131069929893255584207433455232509041864282313720594782838923887462988047045688992892500958076175219578379622239642336626", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[24], "-29355879323580024.8496441085266871730092698706795627370489011260228375962193001532308499081626601957966368166940789818598265207692997726979511113483005928139", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[25], "2444774609921193.00804032928223825267619004401849659522382221798112978896548302453157071772295018879256078690227533557239659342077998372140399717709398185058", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[26], "-163497167040150.994162786872005210426035519530061938479275548273839232529436835358664400989629307142846354676546782632237464086570438150639005260096802709719", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[27], "8640397167115.87775264872573760893122138118525195998042282819991806051276651332447368977618994146175626928442350168473321839559931111026919885615613861450336", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[28], "-353946466836.730528890419989878605687722750489225642509542730180590307713263418581445033480102508048920746914861606738725429428463085371424586288470864717034", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[29], "10980320161.1322307968801550254087969513920106173328968096080132958865209753023214154889544055719394648133777348409390775652438716533676305627930647592322023", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[30], "-250763273.530458775944341688798294822474489803494939027895283252258042909248866669963676665695994207712376717940250071247464430884998217368551649986708865039", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[31], "4071477.35023603998308360217102648949903311403603853888191771600712390650378437914840774599653062889636191131313782153381288032452613084088214900216577861914", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[32], "-45000.8670895165488636652934823710140791941032242997833352090046916107147338701539807529428834617343092289584952502606374402155831751500190349238230473058981", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[33], "320.472215091550748415075485483778157916697578129183535971185536062609638583119802448494231219835700453191619822767882712883842254459363717054782396126797926", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[34], "-1.36970690814297383260078883995593903859391197767092868463665226326025634313296510745370458354235758705938768445773611064873494401594480385699791880988861294", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[35], ".00319863369794435340049321115531520138202389975545923512325662544762994203407848614671572427159051601993009122309753842757834419447199426555693287274751150418", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[36], "-.00000359159981140079587284775448325255766158083360990987597420437266285004731837433526565247999602511489212524340005551363473620703709114460845830537748362419009", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[37], ".00000000161868401788864840585425988502408163784980962647459063888557658617189616922268354635474952471887339736536126800239268153162568237025821827120930941202010937", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[38], "-.000000000000224059435881280018834244185878111046732765351387761375236510813388052012459457403341912918578879516753493868185691279781214484004197586162289666239169671151", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[39], ".00000000000000000624324914973408130631876635093912898085365490736350045222458647371479833210740307637343055039285898285923169335872814711021369175578042169276096790085017798", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[40], "-.0000000000000000000000168975538204125520157924793633044501271722097005208454663077188287247379492184403242738307907586472963818809308140075757465605576503254197189833522656223307", 10, MPFR_RNDN);
        mpfr_set_str(lanczos->c[41], ".0000000000000000000000000000010568006371294132185291930599093557676889607258538590011333906707733337727792422742676579865158249435472039489931607396550324189637751588265482998759258525", 10, MPFR_RNDN);
        break;

    default:
        error("wrong number of Lanczos coefficients");

    }

}

void sl2cfoam_cgamma_lanczos_free(cgamma_lanczos* lanczos) {

    for (int i = 0; i < lanczos->n; i++) {
        mpfr_clear(lanczos->c[i]);
        free(lanczos->c[i]);
    }
    free(lanczos->c);

}
